#!/bin/bash
# Normalize device user access and SSH perms inside the target rootfs
# - No external tool deps (no grep-dctrl)
# - Safe quoting; strict error handling

set -euo pipefail

# Require the primary device user to be defined
U="${KSconf_device_user:?KSconf_device_user unset}"

# If requested, trust the device user with Docker (when the 'docker' group exists)
if [ "${KSconf_meta_docker_trust_user:-n}" = "y" ]; then
  chroot "$1" sh -eu -c '
    if getent group docker >/dev/null 2>&1; then
      adduser "'"$U"'" docker
    fi
  '
fi

# If ~/.ssh exists for the device user, fix ownership and permissions
chroot "$1" sh -eu -c '
  H="/home/'"$U"'"
  if [ -d "$H/.ssh" ]; then
    chown -R "'"$U"':'"$U"'" "$H/.ssh"
    chmod 0700 "$H/.ssh"
    if [ -f "$H/.ssh/authorized_keys" ]; then
      chmod 0600 "$H/.ssh/authorized_keys"
    fi
  fi
'
