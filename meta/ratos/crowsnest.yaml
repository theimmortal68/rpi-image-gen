---
name: ratos-crowsnest
mmdebstrap:
  variant: apt
  packages: []  # assumes git/make and deps are provided by your prerequisite layers
  customize-hooks:
    # --- Clone crowsnest into the device user's home (shallow)
    - >
      chroot "$1" sh -eu -c '
        USER="$IGconf_device_user1"
        cd "/home/$IGconf_device_user1"
        runuser -u "$USER" -- sh -c "git clone --depth 1 https://github.com/mainsail-crew/crowsnest.git crowsnest"
      '

    # --- Install required Debian packages listed by crowsnest's pkglist-rpi.sh (root in chroot)
    - >
      chroot "$1" sh -eu -c '
        INSTALL_SCRIPT="/home/$IGconf_device_user1/crowsnest/tools/libs/pkglist-rpi.sh"
        [ -r "$INSTALL_SCRIPT" ] || { echo "Missing: $INSTALL_SCRIPT" >&2; exit 1; }
        # Source the script to get $PKGLIST, then turn it into positional args safely for /bin/sh
        PKGLIST="$(. "$INSTALL_SCRIPT"; printf "%s" "$PKGLIST")"
        # Convert space/newline separated list into "$@" without bash arrays
        set -- $PKGLIST
        # Install (no-op if list is empty)
        [ $# -eq 0 ] || apt-get update
        [ $# -eq 0 ] || apt-get install -y "$@"
      '

    # --- Run crowsnest installer (non-interactive), then enable the unit via your helper
    - >
      chroot "$1" sh -eu -c '
        export CROWSNEST_UNATTENDED=1
        export CROWSNEST_ADD_CROWSNEST_MOONRAKER=1
        cd "/home/$IGconf_device_user1/crowsnest"
        make install
      '

    # --- Enable the crowsnest service using the bdebstrap helper
    - '"$BDEBSTRAP_HOOKS/enable-units" "$1" crowsnest'
