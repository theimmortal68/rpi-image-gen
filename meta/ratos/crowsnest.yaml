# ratos-crowsnest.yaml
name: ratos-crowsnest
mmdebstrap:
  variant: apt
  packages: []
  customize-hooks:
    - |-
      chroot "$1" /bin/sh -eu -c '
        U="$IGconf_device_user1"
        H="/home/$IGconf_device_user1"

        runuser -u "$U" -- git clone --depth 1 https://github.com/mainsail-crew/crowsnest.git "$H/crowsnest"

        # Install distro packages required by crowsnest (from project script)
        S="$H/crowsnest/tools/libs/pkglist-rpi.sh"
        [ -r "$S" ] || { echo "Missing: $S" >&2; exit 1; }
        PKGLIST="$(. "$S"; printf "%s" "$PKGLIST")"
        if [ -n "$PKGLIST" ]; then
          apt-get update
          # shellcheck disable=SC2086
          apt-get install -y $PKGLIST
        fi

        # Unattended install + Moonraker integration
        export CROWSNEST_UNATTENDED=1
        export CROWSNEST_ADD_CROWSNEST_MOONRAKER=1
        make -C "$H/crowsnest" install
      '
    - '"$BDEBSTRAP_HOOKS/enable-units" "$1" crowsnest'
