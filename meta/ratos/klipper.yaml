---
name: ratos-klipper
mmdebstrap:
  variant: apt
  packages: []   # git, python3, python3-venv, python3-pip come from prerequisite/toolchain layers
  customize-hooks:
    # --- Clone Kalico (Klipper fork) as the device user (shallow, robust: no 'cd')
    - >
      chroot "$1" sh -eu -c '
        U="$IGconf_device_user1"; H="/home/$IGconf_device_user1"
        install -d -m 0755 "$H"; chown "$U:$U" "$H"
        runuser -u "$U" -- git -C "$H" clone --depth 1 --branch bleeding-edge-v2 https://github.com/KalicoCrew/kalico "$H/klipper"
      '

    # --- Create printer_data hierarchy (owned by the device user)
    - >
      chroot "$1" sh -eu -c '
        U="$IGconf_device_user1"; H="/home/$IGconf_device_user1"
        runuser -u "$U" -- sh -c "install -d \
          $H/printer_data \
          $H/printer_data/config \
          $H/printer_data/comms \
          $H/printer_data/logs \
          $H/printer_data/systemd"
      '

    # --- Sanity check: python3 must exist in the chroot
    - 'chroot "$1" sh -eu -c "test -x /usr/bin/python3 && /usr/bin/python3 --version >/dev/null"'

    # --- Python venv for Klipper using stdlib venv
    - >
      chroot "$1" sh -eu -c '
        U="$IGconf_device_user1"; H="/home/$IGconf_device_user1"; V="$H/klippy-env"
        runuser -u "$U" -- sh -c "/usr/bin/python3 -m venv \"$V\""
      '
    - >
      chroot "$1" sh -eu -c '
        U="$IGconf_device_user1"; H="/home/$IGconf_device_user1"; V="$H/klippy-env"
        runuser -u "$U" -- sh -c "\"$V/bin/pip\" install --upgrade pip setuptools wheel"
      '
    - >
      chroot "$1" sh -eu -c '
        U="$IGconf_device_user1"; H="/home/$IGconf_device_user1"; V="$H/klippy-env"
        runuser -u "$U" -- sh -c "\"$V/bin/pip\" install -r \"$H/klipper/scripts/klippy-requirements.txt\""
      '
    - >
      chroot "$1" sh -eu -c '
        U="$IGconf_device_user1"; H="/home/$IGconf_device_user1"; V="$H/klippy-env"
        runuser -u "$U" -- sh -c "\"$V/bin/pip\" install numpy"
      '

    # --- Install systemd unit + env file (host-side copy), then fix ownership of the env
    - 'install -d -m 0755 "$1/etc/systemd/system"'
    - 'install -m 0644 "$RPI_TEMPLATES/klipper/klipper.service" "$1/etc/systemd/system/klipper.service"'
    - 'install -d -m 0755 "$1/home/$IGconf_device_user1/printer_data/systemd"'
    - 'install -m 0644 "$RPI_TEMPLATES/klipper/klipper.env" "$1/home/$IGconf_device_user1/printer_data/systemd/klipper.env"'
    - 'chroot "$1" sh -eu -c "chown $IGconf_device_user1:$IGconf_device_user1 /home/$IGconf_device_user1/printer_data/systemd/klipper.env"'

    # --- Pre-compile Klipper (Python .pyc), as device user
    - >
      chroot "$1" sh -eu -c '
        U="$IGconf_device_user1"; H="/home/$IGconf_device_user1"; V="$H/klippy-env"
        runuser -u "$U" -- sh -c "\"$V/bin/python\" -m compileall \"$H/klipper/klippy\""
      '

    # --- Pre-compile C chelper, as device user
    - >
      chroot "$1" sh -eu -c '
        U="$IGconf_device_user1"; H="/home/$IGconf_device_user1"; V="$H/klippy-env"
        runuser -u "$U" -- sh -c "\"$V/bin/python\" \"$H/klipper/klippy/chelper/__init__.py\""
      '

    # --- Enable the service using the bdebstrap helper (no .service suffix)
    - '"$BDEBSTRAP_HOOKS/enable-units" "$1" klipper'
