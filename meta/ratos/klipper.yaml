---
name: ratos-klipper
mmdebstrap:
  variant: apt
  packages: []   # git, python3, python3-venv, pip, etc. come from prerequisite/toolchain layers
  customize-hooks:
    # --- Clone Kalico (Klipper fork) as the device user
    - 'chroot "$1" sh -eu -c "USER=\\"$IGconf_device_user1\\"; HOME=/home/$IGconf_device_user1; cd \\"$HOME\\"; runuser -u \\"$USER\\" -- git clone --depth 1 --branch bleeding-edge-v2 https://github.com/KalicoCrew/kalico klipper"'

    # --- Create printer_data hierarchy (owned by the device user)
    - 'chroot "$1" sh -eu -c "USER=\\"$IGconf_device_user1\\"; HOME=/home/$IGconf_device_user1; runuser -u \\"$USER\\" -- install -d \\"$HOME/printer_data\\" \\"$HOME/printer_data/config\\" \\"$HOME/printer_data/comms\\" \\"$HOME/printer_data/logs\\" \\"$HOME/printer_data/systemd\\""'

    # --- Python venv for Klipper using stdlib venv (no host helper paths)
    - 'chroot "$1" sh -eu -c "USER=\\"$IGconf_device_user1\\"; ENV_DIR=/home/$IGconf_device_user1/klippy-env; runuser -u \\"$USER\\" -- python3 -m venv \\"$ENV_DIR\\""'
    # (optional but helpful)
    - 'chroot "$1" sh -eu -c "USER=\\"$IGconf_device_user1\\"; ENV_DIR=/home/$IGconf_device_user1/klippy-env; runuser -u \\"$USER\\" -- \\"$ENV_DIR/bin/pip\\" install --upgrade pip setuptools wheel"'
    - 'chroot "$1" sh -eu -c "USER=\\"$IGconf_device_user1\\"; HOME=/home/$IGconf_device_user1; ENV_DIR=/home/$IGconf_device_user1/klippy-env; runuser -u \\"$USER\\" -- \\"$ENV_DIR/bin/pip\\" install -r \\"$HOME/klipper/scripts/klippy-requirements.txt\\""'
    - 'chroot "$1" sh -eu -c "USER=\\"$IGconf_device_user1\\"; ENV_DIR=/home/$IGconf_device_user1/klippy-env; runuser -u \\"$USER\\" -- \\"$ENV_DIR/bin/pip\\" install numpy"'

    # --- Install systemd unit + env file (host-side copy), then fix ownership of the env
    - 'install -d -m 0755 "$1/etc/systemd/system"'
    - 'install -m 0644 "$RPI_TEMPLATES/klipper.service" "$1/etc/systemd/system/klipper.service"'
    - 'install -d -m 0755 "$1/home/$IGconf_device_user1/printer_data/systemd"'
    - 'install -m 0644 "$RPI_TEMPLATES/klipper.env" "$1/home/$IGconf_device_user1/printer_data/systemd/klipper.env"'
    - 'chroot "$1" sh -eu -c "chown $IGconf_device_user1:$IGconf_device_user1 /home/$IGconf_device_user1/printer_data/systemd/klipper.env"'

    # --- Enable the service without systemctl (create wants/ symlink)
    - 'install -d -m 0755 "$1/etc/systemd/system/multi-user.target.wants"'
    - 'ln -sfn ../klipper.service "$1/etc/systemd/system/multi-user.target.wants/klipper.service"'
