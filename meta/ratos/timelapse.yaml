# ratos-timelapse.yaml
name: ratos-timelapse
mmdebstrap:
  variant: apt
  packages: []
  customize-hooks:
    - |-
      chroot "$1" /bin/sh -eu -c '
        U="$KSconf_device_user"
        H="/home/$KSconf_device_user"

        runuser -u "$U" -- git clone --depth 1 https://github.com/mainsail-crew/moonraker-timelapse.git "$H/moonraker-timelapse"

        # Link Moonraker component if Moonraker exists
        C="$H/moonraker/moonraker/components"
        if [ -d "$C" ]; then
          runuser -u "$U" -- ln -sfn "$H/moonraker-timelapse/component/timelapse.py" "$C/timelapse.py"
        fi

        # Link Klipper macro into printer config
        runuser -u "$U" -- sh -eu -c "
          install -d \"$H/printer_data/config\"
          ln -sfn \"$H/moonraker-timelapse/klipper_macro/timelapse.cfg\" \"$H/printer_data/config/timelapse.cfg\"
        "
      '
