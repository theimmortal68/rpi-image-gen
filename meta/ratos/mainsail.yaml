---
name: ratos-mainsail
mmdebstrap:
  variant: apt
  packages: []
  customize-hooks:
    # Host-side: install nginx templates, tweak logrotate, wire symlink
    - |-
      rm -f "$1/etc/nginx/sites-enabled/default"
      install -D -m 0644 "$KS_TEMPLATES/mainsail/mainsail"        "$1/etc/nginx/sites-available/mainsail"
      install -D -m 0644 "$KS_TEMPLATES/mainsail/common_vars.conf" "$1/etc/nginx/conf.d/common_vars.conf"
      install -D -m 0644 "$KS_TEMPLATES/mainsail/upstreams.conf"   "$1/etc/nginx/conf.d/upstreams.conf"
      install -D -m 0644 "$KS_TEMPLATES/mainsail/rsyslog"          "$1/etc/logrotate.d/rsyslog"
      mkdir -p "$1/etc/nginx/sites-enabled"
      ln -sfn /etc/nginx/sites-available/mainsail "$1/etc/nginx/sites-enabled/mainsail"
      sed -i 's/rotate 14/rotate 2/' "$1/etc/logrotate.d/nginx" || true

    # In-chroot: fetch mainsail assets and link config as the device user
    - |-
      chroot "$1" /bin/sh -eu -c '
        U="$1"
        H="/home/$1"

        runuser -u "$U" -- install -d "$H/printer_data/logs"

        # Download & unpack Mainsail into $H/mainsail
        runuser -u "$U" -- sh -eu -c "
          rm -rf \"$H/mainsail\"
          wget -q -O \"$H/mainsail.zip\" https://github.com/mainsail-crew/mainsail/releases/latest/download/mainsail.zip
          unzip -q \"$H/mainsail.zip\" -d \"$H/mainsail\"
          rm -f \"$H/mainsail.zip\"
        "

        # Clone mainsail-config and link into printer_data/config
        runuser -u "$U" -- sh -eu -c "
          git clone --depth 1 https://github.com/mainsail-crew/mainsail-config.git \"$H/mainsail-config\"
          install -d \"$H/printer_data/config\"
          ln -sfn \"$H/mainsail-config/mainsail.cfg\" \"$H/printer_data/config/mainsail.cfg\"
        "
      ' -- "$KSconf_device_user"
