# ratos-sonar.yaml
name: ratos-sonar
mmdebstrap:
  variant: apt
  packages: []
  customize-hooks:
    - |-
      chroot "$1" /bin/sh -eu -c '
        U="$KSconf_device_user"
        H="/home/$KSconf_device_user"

        runuser -u "$U" -- git clone --depth 1 https://github.com/mainsail-crew/sonar.git "$H/sonar"

        # Provide .config for unattended install (then remove)
        runuser -u "$U" -- sh -eu -c "
          install -d \"$H/sonar/tools\"
          {
            echo \"BASE_USER=$U\"
            echo \"SONAR_DATA_PATH=$H/printer_data\"
            echo \"SONAR_ADD_SONAR_MOONRAKER=1\"
            echo \"SONAR_UNATTENDED=1\"
          } > \"$H/sonar/tools/.config\"
        "

        make -C "$H/sonar" install
        runuser -u "$U" -- rm -f "$H/sonar/tools/.config"
      '
    - '"$BDEBSTRAP_HOOKS/enable-units" "$1" sonar'
