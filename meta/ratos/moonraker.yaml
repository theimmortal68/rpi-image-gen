# ratos-moonraker.yaml
name: ratos-moonraker
mmdebstrap:
  variant: apt
  packages: []
  customize-hooks:
    - |-
      chroot "$1" /bin/sh -eu -c '
        U="$IGconf_device_user1"
        H="/home/$IGconf_device_user1"

        # Clone as user
        runuser -u "$U" -- git clone --depth 1 https://github.com/Arksine/moonraker.git "$H/moonraker"

        # Install unattended (-s -z)
        runuser -u "$U" -- sh -eu -c "\"$H/moonraker/scripts/install-moonraker.sh\" -s -z"

        # Config: drop moonraker.conf from templates as user
        runuser -u "$U" -- sh -eu -c "install -D -m 0644 \"$RPI_TEMPLATES/moonraker.conf\" \"$H/printer_data/config/moonraker.conf\""
      '
    - '"$BDEBSTRAP_HOOKS/enable-units" "$1" moonraker'
