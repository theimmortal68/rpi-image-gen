# ratos-moonraker.yaml
name: ratos-moonraker
mmdebstrap:
  variant: apt
  packages: []
  customize-hooks:
    # --- In-chroot: user-scoped work (username passed as $1)
    - |-
      chroot "$1" /bin/sh -eu -c '
        U="$1"
        H="/home/$U"
        ENV_DIR="$H/moonraker-env"

        # Clone Moonraker as the device user
        runuser -u "$U" -- git clone --depth 1 https://github.com/Arksine/moonraker.git "$H/moonraker"

        # Create a dedicated venv for Moonraker and install deps
        runuser -u "$U" -- /usr/bin/python3 -m venv "$ENV_DIR"
        runuser -u "$U" -- "$ENV_DIR/bin/pip" install --upgrade pip setuptools wheel
        runuser -u "$U" -- "$ENV_DIR/bin/pip" install -r "$H/moonraker/requirements.txt"

        # Ensure printer_data/config exists (ok if it already exists)
        runuser -u "$U" -- install -d "$H/printer_data/config"
      ' _ "$KSconf_device_user"

    # --- Host-side: drop service + config from templates, then enable unit
    - |-
      # Service file from templates
      install -D -m 0644 "$KS_TEMPLATES/moonraker/moonraker.service" \
        "$1/etc/systemd/system/moonraker.service"

      # Moonraker config from templates into the user's tree
      install -D -m 0644 "$KS_TEMPLATES/moonraker.conf" \
        "$1/home/$KSconf_device_user/printer_data/config/moonraker.conf"

      # Enable via your helper (no .service suffix)
      "$BDEBSTRAP_HOOKS/enable-units" "$1" moonraker      "$BDEBSTRAP_HOOKS/enable-units" "$1" moonraker
