---
name: networkmanager
mmdebstrap:
  packages:
    - network-manager
  customize-hooks:
    - |-
      # Configure NetworkManager inside the target rootfs
      chroot "$1" /bin/sh -eu -c '
        # Make sure systemd-networkd is NOT active if it happens to be present
        systemctl disable systemd-networkd 2>/dev/null || true

        # Enable NetworkManager
        systemctl enable NetworkManager

        # Provide a simple DHCP profile for eth0
        install -d -m 0700 /etc/NetworkManager/system-connections
        cat > /etc/NetworkManager/system-connections/eth0.nmconnection <<EOF
        [connection]
        id=eth0
        type=ethernet
        interface-name=eth0
        autoconnect=true

        [ipv4]
        method=auto

        [ipv6]
        addr-gen-mode=stable-privacy
        method=auto
        EOF
        chmod 600 /etc/NetworkManager/system-connections/eth0.nmconnection

        # Optional: ensure NM manages all devices (kept minimal/sane)
        install -d -m 0755 /etc/NetworkManager/conf.d
        cat > /etc/NetworkManager/conf.d/10-default.conf <<EOF
        [main]
        plugins=keyfile
        EOF
      '
