name: ratos-canbus-nm
mmdebstrap:
  variant: apt
  packages: []
  customize-hooks:
    - |-
      # write NM connection file directly using the hook's $1 (rootfs)
      F="$1/etc/NetworkManager/system-connections/can0.nmconnection"
      install -d -m 0700 "$(dirname "$F")"
      cat > "$F" <<'EOF'
      [connection]
      id=can0
      uuid=6f1d9d9c-9c0d-4b5b-9c79-2a4a7d1a1a00
      type=can
      autoconnect=true

      [can]
      bitrate=1000000
      fd=false
      listen-only=false
      restart-ms=100

      [ipv4]
      method=disabled

      [ipv6]
      method=ignore
      EOF
      chmod 0600 "$F"

      # ensure CAN modules load at boot
      {
        echo can
        echo can_raw
        echo vcan
      } > "$1/etc/modules-load.d/can.conf"
