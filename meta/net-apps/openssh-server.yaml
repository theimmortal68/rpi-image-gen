---
name: openssh server
mmdebstrap:
  variant: apt
  packages:
    - openssh-server
  customize-hooks:
    - mkdir -p $1/home/${KSconf_device_user}/.ssh
    - |-
      if [ -z ${KSconf_meta_ssh_pubkey_user1+x} ]; then
         touch $1/home/${KSconf_device_user}/.ssh/authorized_keys
      elif [ -f "$KSconf_meta_ssh_pubkey_user1" ] ; then
         cat $KSconf_meta_ssh_pubkey_user1 > $1/home/${KSconf_device_user}/.ssh/authorized_keys
      else
         echo "$KSconf_meta_ssh_pubkey_user1" > $1/home/${KSconf_device_user}/.ssh/authorized_keys
      fi
    - |-
      if igconf isy meta_sshd_pubkey_only ; then
         mkdir -p $1/etc/ssh/sshd_config.d
         printf %s\n "      PermitRootLogin no" "      ChallengeResponseAuthentication no" "      PasswordAuthentication no" "      GSSAPIAuthentication no" "      UsePAM yes" "      PubkeyAuthentication yes" "      AuthenticationMethods publickey" > $1/etc/ssh/sshd_config.d/01pubkey-only.conf
      fi
    - $KS_HELPERS/enable-units "$1" ssh
