name: net-apps/openssh-server
mmdebstrap:
  variant: apt
  # Packages are expected to be pre-installed by ratos-prerequisite per your policy.
  packages: []
  customize-hooks:
    # Ensure ~/.ssh, authorized_keys for the device user.
    - >
      chroot "$1" sh -eu -c '
        U="$KSconf_device_user"
        H="/home/$KSconf_device_user"
        test -n "$U"
        install -d -m 0700 "$H/.ssh"
        if [ -n "${KSconf_meta_ssh_pubkey:-}" ]; then
          if [ -f "${KSconf_meta_ssh_pubkey}" ]; then
            cat "${KSconf_meta_ssh_pubkey}" > "$H/.ssh/authorized_keys"
          else
            printf "%s\n" "${KSconf_meta_ssh_pubkey}" > "$H/.ssh/authorized_keys"
          fi
          chmod 0600 "$H/.ssh/authorized_keys"
        fi
        chown -R "$U:$U" "$H/.ssh"
      '
    # Harden SSHd (optional): disallow password auth if a key was provided
    - >
      chroot "$1" sh -eu -c '
        if [ -n "${KSconf_meta_ssh_pubkey:-}" ] && [ -f /etc/ssh/sshd_config ]; then
          sed -i -E "s/^[# ]*PasswordAuthentication .*/PasswordAuthentication no/" /etc/ssh/sshd_config || true
          sed -i -E "s/^[# ]*ChallengeResponseAuthentication .*/ChallengeResponseAuthentication no/" /etc/ssh/sshd_config || true
        fi
      '
    # Enable the service if your helper manages units without .service suffix
    - '"$BDEBSTRAP_HOOKS/enable-units" "$1" ssh'
