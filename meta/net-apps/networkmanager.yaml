---
name: networkmanager
mmdebstrap:
  variant: apt
  packages:
    - network-manager
  customize-hooks:
    - |-
      chroot "$1" /bin/sh -eu -c '
        # Disable competing stacks if present
        systemctl disable systemd-networkd 2>/dev/null
        systemctl disable systemd-resolved 2>/dev/null
        systemctl mask    systemd-resolved 2>/dev/null
        # NetworkManager DNS settings (no systemd-resolved)
        install -d -m 0755 /etc/NetworkManager/conf.d
        cat > /etc/NetworkManager/conf.d/10-dns.conf <<'"'"'CONF'"'"'
        [main]
        dns=default
        rc-manager=file
        CONF

        # Simple DHCP profile for eth0
        install -d -m 0700 /etc/NetworkManager/system-connections
        cat > /etc/NetworkManager/system-connections/eth0.nmconnection <<'"'"'NMCONF'"'"'
        [connection]
        id=eth0
        type=ethernet
        interface-name=eth0
        autoconnect=true

        [ipv4]
        method=auto

        [ipv6]
        addr-gen-mode=stable-privacy
        method=auto
        NMCONF
        chmod 600 /etc/NetworkManager/system-connections/eth0.nmconnection
      '
    - $KS_HELPERS/enable-units "$1" NetworkManager
