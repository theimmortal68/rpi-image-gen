---
name: headless-nm
mmdebstrap:
  variant: apt
  packages: []
  customize-hooks:
    # Install boot templates (prefer /boot/firmware if present)
    - install -d -m 0755 "$(test -d "$1/boot/firmware" && echo "$1/boot/firmware" || echo "$1/boot")"
    - install -m 0644 "$KS_TEMPLATES/headless-nm/headless_nm.txt.template" "$(test -d "$1/boot/firmware" && echo "$1/boot/firmware" || echo "$1/boot")/headless_nm.txt.template"
    - install -m 0644 "$KS_TEMPLATES/headless-nm/WiFi-README.txt" "$(test -d "$1/boot/firmware" && echo "$1/boot/firmware" || echo "$1/boot")/WiFi-README.txt"
    - sed -i "s|OS_NAME|${KSconf_sys_dist_name:-Debian}|g" "$(test -d "$1/boot/firmware" && echo "$1/boot/firmware" || echo "$1/boot")/WiFi-README.txt"

    # Install systemd unit and helper script
    - install -d -m 0755 "$1/etc/systemd/system"
    - install -m 0644 "$KS_TEMPLATES/headless-nm/headless_nm.service" "$1/etc/systemd/system/headless_nm.service"
    - install -d -m 0755 "$1/usr/local/bin"
    - install -m 0755 "$KS_TEMPLATES/headless-nm/headless_nm" "$1/usr/local/bin/headless_nm"

    # Wi-Fi powersave udev rule
    - install -d -m 0755 "$1/etc/udev/rules.d"
    - install -m 0644 "$KS_TEMPLATES/udev/070-wifi-powersave.rules" "$1/etc/udev/rules.d/070-wifi-powersave.rules"

    # Enable the service without systemctl (create wants/ symlink)
    - install -d -m 0755 "$1/etc/systemd/system/multi-user.target.wants"
    - ln -sfn ../headless_nm.service "$1/etc/systemd/system/multi-user.target.wants/headless_nm.service"
