---
name: systemd-core-min
mmdebstrap:
  packages:
    - systemd
    - systemd-sysv
    - systemd-timesyncd
  customize-hooks:
    - |-
      # Run everything inside the target rootfs
      chroot "$1" /bin/sh -eu -c '
        # Enable time sync
        systemctl enable systemd-timesyncd

        # Persistent journal (directory + group) and size cap (~100 MB total)
        install -d -m 2755 /var/log/journal
        chown root:systemd-journal /var/log/journal
        install -d -m 0755 /etc/systemd/journald.conf.d
        printf %s\n "        [Journal]" "        SystemMaxUse=100M" > /etc/systemd/journald.conf.d/99-rotate.conf

        # Keep TTY1 output visible after boot
        install -d -m 0755 /etc/systemd/system/getty@tty1.service.d
        printf %s\n "        [Service]" "        TTYVTDisallocate=no" > /etc/systemd/system/getty@tty1.service.d/noclear.conf

        # Neutralize udev default link renames for predictable names
        install -d -m 0755 /etc/systemd/network
        ln -sf /dev/null /etc/systemd/network/99-default.link
        ln -sf /dev/null /etc/systemd/network/73-usb-net-by-mac.link
      '
