---
name: systemd-core-min
mmdebstrap:
  packages:
    - systemd
    - systemd-sysv
    - systemd-timesyncd
    - systemd-resolved
  customize-hooks:
    - |-
      chroot "$1" /bin/sh -eu -c '
        # Enable core services
        systemctl enable systemd-timesyncd
        systemctl enable systemd-resolved
        systemctl enable systemd-journald

        # Build-time DNS: keep a plain resolv.conf so APT works in chroot
        cat > /etc/resolv.conf <<EOF
        # Temporary resolv.conf for image build (replaced at boot via tmpfiles)
        nameserver 1.1.1.1
        nameserver 9.9.9.9
        options edns0
        EOF

        # Defer the switch to systemd-resolved stub to first boot via tmpfiles
        install -d -m 0755 /usr/lib/tmpfiles.d
        cat > /usr/lib/tmpfiles.d/00-resolved.conf <<EOF
        # Create the resolv.conf symlink at boot, when resolved is actually running
        L /etc/resolv.conf - - - - /run/systemd/resolve/stub-resolv.conf
        EOF

        # Persistent journal
        install -d -m 2755 /var/log/journal
        chown root:systemd-journal /var/log/journal

        # Keep TTY1 output visible after boot
        install -d -m 0755 /etc/systemd/system/getty@tty1.service.d
        cat > /etc/systemd/system/getty@tty1.service.d/noclear.conf <<EOF
        [Service]
        TTYVTDisallocate=no
        EOF

        # Neutralize udev default link renames
        install -d -m 0755 /etc/systemd/network
        ln -sf /dev/null /etc/systemd/network/99-default.link
        ln -sf /dev/null /etc/systemd/network/73-usb-net-by-mac.link
      '
