---
name: rpi-essential-base
mmdebstrap:
  variant: apt
  packages:
    - ca-certificates
    - curl
    - wget
    - iproute2
    - iputils-ping
    - sudo
    - micro
    - less
    - bash-completion
    - openssh-client
    - procps
    - udev
    - zstd
  customize-hooks:
    - |-
      chroot "$1" /bin/sh -eu -c '
        # Make micro the default editor
        update-alternatives --install /usr/bin/editor editor /usr/bin/micro 50
        update-alternatives --set editor /usr/bin/micro

        # Export EDITOR/VISUAL for all users
        install -d -m 0755 /etc/profile.d
        printf "%s\n" \
          "export EDITOR=/usr/bin/micro" \
          "export VISUAL=/usr/bin/micro" \
          > /etc/profile.d/99-editor.sh
        chmod 0644 /etc/profile.d/99-editor.sh

        # Seed /etc/skel with micro settings
        install -d -m 0755 /etc/skel/.config/micro
        printf "%s\n" \
          "{" \
          "  \"softwrap\": true," \
          "  \"tabsize\": 2," \
          "  \"autosu\": true" \
          "}" \
          > /etc/skel/.config/micro/settings.json
        chmod 0644 /etc/skel/.config/micro/settings.json
      '
