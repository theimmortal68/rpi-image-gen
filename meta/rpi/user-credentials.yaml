---
name: rpi-user-creds
mmdebstrap:
  variant: apt
  packages: []   # NOTE: assumes 'sudo' is provided by ratos-prerequisite
  customize-hooks:
    # Ensure the user exists (no password yet)
    - >
      chroot "$1" sh -eu -c '
        if ! id -u "$KSconf_device_user" >/dev/null 2>&1; then
          adduser --disabled-password --gecos "" "$KSconf_device_user"
        fi
      '

    # Set the password if provided (plaintext or crypt hash)
    - >
      chroot "$1" sh -eu -c '
        if [ -n "${KSconf_device_password:-}" ]; then
          case "$KSconf_device_password" in
            \$6\$*|\$5\$*|\$2*|\$y\$*|\$argon2*)
              echo "${KSconf_device_user}:${KSconf_device_password}" | chpasswd -e ;;
            *)
              echo "${KSconf_device_user}:${KSconf_device_password}" | chpasswd ;;
          esac
        fi
      '

    # Lock root account
    - 'chroot "$1" usermod -p "*" root'

    # Ensure expected groups exist (harmless if already present)
    - >
      chroot "$1" sh -eu -c '
        for GRP in input spi i2c gpio; do
          getent group "$GRP" >/dev/null || groupadd -r "$GRP"
        done
      '

    # Add the device user to groups (you keep this authoritative here)
    - >
      chroot "$1" sh -eu -c '
        for GRP in adm dialout cdrom audio users sudo video games plugdev input spi i2c gpio tty render; do
          adduser "$KSconf_device_user" "$GRP"
        done
      '

    # Sudoers drop-in (from template), with correct perms/ownership
    - >
      /bin/sh -eu -c '
        D="$1/etc/sudoers.d"
        install -d -m 0755 "$D"
        sed "s/^pi /$KSconf_device_user /" "$KS_TEMPLATES/sudo/010_pi-nopasswd" > "$D/010_pi-nopasswd"
        chmod 0440 "$D/010_pi-nopasswd"
        chroot "$1" sh -eu -c "chown root:root /etc/sudoers.d/010_pi-nopasswd; command -v visudo >/dev/null && visudo -cf /etc/sudoers.d/010_pi-nopasswd || true"
      '

    # PATH normalization for non-root shells
    - >
      /bin/sh -eu -c '
        install -d -m 0755 "$1/etc/profile.d"
        cat >"$1/etc/profile.d/01local.sh" <<'"'"'SH'"'"'
#!/bin/sh
if [ "$(id -u)" -ne 0 ]; then
  PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/games:/usr/games
fi
SH
        chmod 0644 "$1/etc/profile.d/01local.sh"
      '
